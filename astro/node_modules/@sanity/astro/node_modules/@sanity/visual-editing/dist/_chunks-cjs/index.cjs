"use strict";var e=require("./create-data-attribute.cjs"),t=require("@vercel/stega");let n;require("./enableVisualEditing.cjs");const o=new Uint8Array(16);function r(){if(!n&&(n=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!n))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(o)}const s=[];for(let e=0;e<256;++e)s.push((e+256).toString(16).slice(1));var i={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function c(e,t,n){if(i.randomUUID&&!t&&!e)return i.randomUUID();const o=(e=e||{}).random||(e.rng||r)();return o[6]=15&o[6]|64,o[8]=63&o[8]|128,function(e,t=0){return s[e[t+0]]+s[e[t+1]]+s[e[t+2]]+s[e[t+3]]+"-"+s[e[t+4]]+s[e[t+5]]+"-"+s[e[t+6]]+s[e[t+7]]+"-"+s[e[t+8]]+s[e[t+9]]+"-"+s[e[t+10]]+s[e[t+11]]+s[e[t+12]]+s[e[t+13]]+s[e[t+14]]+s[e[t+15]]}(o)}const a="sanity-visual-editing";function l(e){const{display:t}=window.getComputedStyle(e);if("inline"!==t)return e;const n=e.parentElement;return n?l(n):null}function u(e,n=!1){return o=e,t.VERCEL_STEGA_REGEX.lastIndex=0,t.VERCEL_STEGA_REGEX.test(o)?function(e,n=!1){var o;try{const r=t.vercelStegaDecode(e);return r&&"sanity.io"===r.origin?(n&&(r.href=null==(o=r.href)?void 0:o.replace(".alt","")),r):null}catch(t){return console.error("Failed to decode stega for string: ",e,"with the original error: ",t),null}}(e,n):null;var o}const d=e=>e.nodeType===Node.ELEMENT_NODE,m=e=>"IMG"===e.tagName,f=e=>"TIME"===e.tagName,v=e=>"SVG"===e.tagName.toUpperCase();function p(e){return"path"in e}function y(e,t){let n=e.split("."),o=t.split(".");const r=Math.min(n.length,o.length);return n=n.slice(0,r).reverse(),o=o.slice(0,r).reverse(),n.reduce(((e,t,n)=>t===o[n]?[...e,t]:[]),[]).reverse().join(".")}function E(e){if(!e.length||!e.map((e=>p(e))).every(((e,t,n)=>e===n[0])))return;if(!p(e[0]))return e[0];const t=e.filter(p);let n=e[0];const o=["projectId","dataset","id","baseUrl","workspace","tool"];for(let e=1;e<t.length;e++){const r=t[e];if(o.some((e=>r[e]!==(null==n?void 0:n[e])))){n=void 0;break}n.path=y(n.path,r.path)}return n}function g(t){var n,o,r;const s=[];function i(t,n){const o=e.I(n);if(!o)return;const r=l(t);r&&s.push({elements:{element:t,measureElement:r},sanity:o})}if(t)for(const e of t.childNodes){const{nodeType:t,parentElement:c,textContent:l}=e;if(d(e)&&void 0!==(null==(n=e.dataset)?void 0:n.sanityEditTarget)){const t=g(e).map((({sanity:e})=>e));if(!t.map((e=>p(e))).every(((e,t,n)=>e===n[0])))continue;const n=E(t);n&&s.push({elements:{element:e,measureElement:e},sanity:n})}else if(t===Node.TEXT_NODE&&c&&l){const e=u(l);if(!e)continue;i(c,e)}else if(d(e)){if("SCRIPT"===e.tagName||e.id===a)continue;if(null!=(o=e.dataset)&&o.sanity)i(e,e.dataset.sanity);else if(null!=(r=e.dataset)&&r.sanityEditInfo)i(e,e.dataset.sanityEditInfo);else{if(m(e)){const t=u(e.alt,!0);if(!t)continue;i(e,t);continue}if(f(e)){const t=u(e.dateTime,!0);if(!t)continue;i(e,t)}else if(v(e)){if(!e.ariaLabel)continue;const t=u(e.ariaLabel,!0);if(!t)continue;i(e,t)}}s.push(...g(e))}}return s}function h(e){const t=e.getBoundingClientRect();return{x:t.x+scrollX,y:t.y+scrollY,w:t.width,h:t.height}}const w=e=>e instanceof HTMLElement||e instanceof SVGElement;exports.O=a,exports.c=function({handler:e,overlayElement:t,preventDefault:n}){let o=!1;const r=new Map,s=new WeakMap,i=new Set,a=new WeakMap;let l,u,d,m=[];const f=()=>m[m.length-1];function v(e,t){e.removeEventListener("click",t.click,{capture:!0}),e.removeEventListener("mousemove",t.mousemove,{capture:!0}),e.removeEventListener("mousedown",t.mousedown,{capture:!0}),e.removeEventListener("mouseenter",t.mouseenter),e.removeEventListener("mouseleave",t.mouseleave)}function p({id:t,elements:n,handlers:o,sanity:r}){const{element:s,measureElement:i}=n;(function(e,t){e.addEventListener("click",t.click,{capture:!0}),e.addEventListener("mousemove",t.mousemove,{once:!0,capture:!0}),e.addEventListener("mousedown",t.mousedown,{capture:!0})})(s,o),l.observe(i),e({type:"element/activate",id:t,rect:h(s),sanity:r})}function y({id:t,elements:n,handlers:o}){const{element:r,measureElement:s}=n;v(r,o),l.unobserve(s),m=m.filter((e=>e!==r)),e({type:"element/deactivate",id:t})}function E({elements:o,sanity:l}){const{element:d,measureElement:v}=o,p={click(t){const o=t.target;d===f()&&d.contains(o)&&(n&&(t.preventDefault(),t.stopPropagation()),e({type:"element/click",id:y,sanity:l}))},mousedown(e){e.preventDefault()},mousemove(e){p.mouseenter(e);const t=e.currentTarget;t&&(t.addEventListener("mouseenter",p.mouseenter),t.addEventListener("mouseleave",p.mouseleave))},mouseenter(){document.querySelector("vercel-live-feedback")&&d.closest("[data-vercel-edit-info]")||d.closest("[data-vercel-edit-target]")||(m.push(d),e({type:"element/mouseenter",id:y,rect:h(d)}))},mouseleave(n){function o(){m.pop();const t=f();if(e({type:"element/mouseleave",id:y}),t){const n=s.get(t);n&&e({type:"element/mouseenter",id:n.id,rect:h(t)})}}const{relatedTarget:r}=n;if(w(r)&&t.contains(r)){const e=()=>{o(),r.removeEventListener("mouseleave",e)};r.addEventListener("mouseleave",e)}else o()}},y=c(),E={id:y,elements:o,sanity:l,handlers:p};i.add(d),a.set(v,d),r.set(y,d),s.set(d,E),null==u||u.observe(d),e({type:"element/register",id:y,rect:h(d),sanity:l})}function L(e){const t=g(e);for(const e of t)w(e.elements.element)&&!s.has(e.elements.element)&&E(e)}function b(t){const n=s.get(t);if(n){const{id:o,handlers:c}=n;v(t,c),l.unobserve(t),s.delete(t),i.delete(t),r.delete(o),e({type:"element/unregister",id:o})}}function I(e){if(e.filter((e=>{const n=e.target;return n!==t&&!t.contains(n)&&(w(n)&&(s.has(n)&&b(n),L({childNodes:[n]})),!0)})).length)for(const e of i)e.isConnected?T(e):b(e)}function T(t){const n=s.get(t);n&&e({type:"element/updateRect",id:n.id,rect:h(t)})}function k(e){for(const t of e){const e=t.target;if(w(e)){const t=a.get(e);if(!t)return;T(t)}}}function U(e){if(o)for(const t of e){const{target:e}=t,n=w(e)&&s.get(e);n&&(t.isIntersecting?p(n):y(n))}}function D(){m=[],e({type:"overlay/blur"})}function N(){for(const e of i)T(e)}function R(e){const{target:t}=e;if(t!==window.document&&w(t))for(const e of i)t.contains(e)&&T(e)}function S(){o||(u=new IntersectionObserver(U,{threshold:.3}),i.forEach((e=>u.observe(e))),e({type:"overlay/activate"}),o=!0)}function M(){o&&(null==u||u.disconnect(),i.forEach((e=>{const t=s.get(e);t&&y(t)})),e({type:"overlay/deactivate"}),o=!1)}return window.document.fonts.ready.then((()=>{for(const e of i)T(e)})),window.addEventListener("click",D),window.addEventListener("resize",N),window.addEventListener("scroll",R,{capture:!0,passive:!0}),l=new ResizeObserver(k),d=new MutationObserver(I),d.observe(document.body,{attributes:!0,characterData:!0,childList:!0,subtree:!0}),L(document.body),S(),{activate:S,deactivate:M,destroy:function(){window.removeEventListener("click",D),window.removeEventListener("resize",N),window.removeEventListener("scroll",R),d.disconnect(),l.disconnect(),i.forEach((e=>{b(e)})),r.clear(),i.clear(),m=[],M()}}},exports.v=c;//# sourceMappingURL=index.cjs.map
