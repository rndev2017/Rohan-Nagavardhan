{"version":3,"file":"define-preview-url.js","sources":["../src/definePreviewUrl.ts"],"sourcesContent":["import {urlSearchParamPreviewPathname, urlSearchParamPreviewSecret} from './constants'\nimport type {\n  PreviewUrlResolver,\n  PreviewUrlResolverContext,\n  PreviewUrlResolverOptions,\n} from './types'\n\n/**\n * @internal\n */\nexport function definePreviewUrl<SanityClientType>(\n  options: PreviewUrlResolverOptions,\n): PreviewUrlResolver<SanityClientType> {\n  const {\n    draftMode,\n    previewMode,\n    origin = typeof location === 'undefined' ? 'https://localhost' : location.origin,\n  } = options\n  const enableUrl = previewMode?.enable || draftMode?.enable\n  let {preview = '/'} = options\n  const productionUrl = new URL(preview, origin)\n  const enablePreviewModeUrl = enableUrl ? new URL(enableUrl, origin) : undefined\n\n  return async (context): Promise<string> => {\n    try {\n      if (context.previewSearchParam) {\n        const restoredUrl = new URL(context.previewSearchParam, productionUrl)\n        if (restoredUrl.origin === productionUrl.origin) {\n          preview = `${restoredUrl.pathname}${restoredUrl.search}`\n        }\n      } else if (context.referrer) {\n        const referrerUrl = new URL(context.referrer)\n        if (referrerUrl.origin === productionUrl.origin) {\n          preview = `${referrerUrl.pathname}${referrerUrl.search}`\n        }\n      }\n    } catch {\n      // ignore\n    }\n    // Prevent infinite recursion\n    if (\n      typeof location !== 'undefined' &&\n      location.origin === productionUrl.origin &&\n      context.studioBasePath &&\n      (preview.startsWith(`${context.studioBasePath}/`) || preview === context.studioBasePath)\n    ) {\n      preview = options.preview || '/'\n    }\n    const previewUrl = new URL(preview, productionUrl)\n    if (enablePreviewModeUrl) {\n      const enablePreviewModeRequestUrl = new URL(enablePreviewModeUrl)\n      const {searchParams} = enablePreviewModeRequestUrl\n      searchParams.set(urlSearchParamPreviewSecret, context.previewUrlSecret)\n      if (previewUrl.pathname !== enablePreviewModeRequestUrl.pathname) {\n        searchParams.set(\n          urlSearchParamPreviewPathname,\n          `${previewUrl.pathname}${previewUrl.search}`,\n        )\n      }\n\n      return enablePreviewModeRequestUrl.toString()\n    }\n    return previewUrl.toString()\n  }\n}\n\nexport type {PreviewUrlResolver, PreviewUrlResolverContext, PreviewUrlResolverOptions}\n"],"names":["definePreviewUrl","options","draftMode","previewMode","origin","location","enableUrl","enable","preview","productionUrl","URL","enablePreviewModeUrl","async","context","previewSearchParam","restoredUrl","pathname","search","referrer","referrerUrl","studioBasePath","startsWith","previewUrl","enablePreviewModeRequestUrl","searchParams","set","urlSearchParamPreviewSecret","previewUrlSecret","urlSearchParamPreviewPathname","toString"],"mappings":"qDAUO,SAASA,EACdC,GAEM,MAAAC,UACJA,EAAAC,YACAA,EAAAC,OACAA,UAAgBC,SAAa,IAAc,oBAAsBA,SAASD,SACxEH,EACEK,GAAY,MAAAH,OAAA,EAAAA,EAAaI,UAAqB,MAAXL,OAAW,EAAAA,EAAAK,QAChD,IAAAC,QAACA,EAAU,KAAOP,EACtB,MAAMQ,EAAgB,IAAIC,IAAIF,EAASJ,GACjCO,EAAuBL,EAAY,IAAII,IAAIJ,EAAWF,QAAU,EAEtE,OAAOQ,MAAOC,IACR,IACF,GAAIA,EAAQC,mBAAoB,CAC9B,MAAMC,EAAc,IAAIL,IAAIG,EAAQC,mBAAoBL,GACxCM,EAAAX,SAAWK,EAAcL,SACvCI,EAAU,GAAGO,EAAYC,WAAWD,EAAYE,SAAM,MAAA,GAE/CJ,EAAQK,SAAU,CAC3B,MAAMC,EAAc,IAAIT,IAAIG,EAAQK,UACpBC,EAAAf,SAAWK,EAAcL,SACvCI,EAAU,GAAGW,EAAYH,WAAWG,EAAYF,SAEpD,CAAA,CACM,MAER,QAGSZ,SAAa,KACpBA,SAASD,SAAWK,EAAcL,QAClCS,EAAQO,iBACPZ,EAAQa,WAAW,GAAGR,EAAQO,oBAAsBZ,IAAYK,EAAQO,kBAEzEZ,EAAUP,EAAQO,SAAW,KAE/B,MAAMc,EAAa,IAAIZ,IAAIF,EAASC,GACpC,GAAIE,EAAsB,CACxB,MAAMY,EAA8B,IAAIb,IAAIC,IACtCa,aAACA,GAAgBD,EACV,OAAAC,EAAAC,IAAIC,EAA6Bb,EAAQc,kBAClDL,EAAWN,WAAaO,EAA4BP,UACtDQ,EAAaC,IACXG,EACA,GAAGN,EAAWN,WAAWM,EAAWL,UAIjCM,EAA4BM,UACrC,CACA,OAAOP,EAAWO,WAEtB"}