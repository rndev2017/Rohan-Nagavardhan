import{jsxs as e,Fragment as t,jsx as n}from"react/jsx-runtime";import{useMemo as r,useState as s,useEffect as o,useSyncExternalStore as c,useCallback as a,memo as i}from"react";import{applySourceDocuments as u,getPublishedId as l}from"@sanity/client/csm";import{applyPatch as d}from"mendoza";import p from"mnemonist/lru-cache-with-delete";import{useClient as f}from"sanity";import{L as m,e as h}from"./index.js";function v(e){return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)}function w(c){const{liveDocument:a,channel:i,perspective:u,liveQueries:l,documentsOnPage:d}=c,[h]=s((()=>new p(m))),v=f({apiVersion:"2023-10-16"}),w=r((()=>v.config()),[v]),g=r((()=>v.withConfig({resultSourceMap:"withKeyArraySelector"})),[v]);o((()=>{if(i){const{projectId:e,dataset:t}=w;i.send("loaders","loader/perspective",{projectId:e,dataset:t,perspective:u})}}),[i,w,u]);const L=r((()=>{const e=d.map((({_id:e})=>e)),t=[...new Set(e)],n=h.capacity;return t.length>=n&&(t.length=n),t}),[h.capacity,d]),[S,b]=s(0);return e(t,{children:[n(y,{cache:h,client:g,turboIds:L,setDocumentsCacheLastUpdated:b}),Object.entries(l).map((([e,{query:t,params:r,perspective:s}])=>n(I,{cache:h,projectId:w.projectId,dataset:w.dataset,perspective:s,query:t,params:r,channel:i,client:g,refreshInterval:u?2e3:0,liveDocument:a,documentsCacheLastUpdated:S},`${e}${s}`)))]})}const y=i((function(e){const{cache:r,client:c,turboIds:a,setDocumentsCacheLastUpdated:i}=e,[u,l]=s([]);return o((()=>{const e=new Set(u.flat()),t=new Set;for(const n of a)!e.has(n)&&!r.has(n)&&t.add(n);const n=[...t].slice(0,h);0!==n.length&&l((e=>[...e.slice(-h),n]))}),[u,r,a]),o((()=>{const e=c.listen("*",{},{events:["mutation"],effectFormat:"mendoza",includePreviousRevision:!1,includeResult:!1,tag:"presentation-loader"}).subscribe((e=>{var t,n;if("mutation"===e.type&&"disappear"===e.transition&&r.delete(e.documentId)&&i(Date.now()),"mutation"!==e.type||null==(n=null==(t=e.effects)?void 0:t.apply)||!n.length)return;const s=r.peek(e.documentId);if(s){const t={...s};delete t._rev;const n=d(t,e.effects.apply);r.set(e.documentId,n),i(Date.now())}}));return()=>e.unsubscribe()}),[r,c,i]),n(t,{children:u.map((e=>n(g,{cache:r,client:c,ids:e,setDocumentsCacheLastUpdated:i},JSON.stringify(e))))})})),g=i((function(e){const{client:t,cache:n,ids:r,setDocumentsCacheLastUpdated:s}=e;return o((()=>{const e=r.filter((e=>!n.has(e)));0!==e.length&&t.getDocuments(e).then((e=>{for(const t of e)t&&null!=t&&t._id&&(n.set(t._id,t),s(Date.now()))}),console.error)}),[n,t,r,s]),null}));function I(e){const{cache:t,projectId:n,dataset:i,perspective:u,query:l,client:d,refreshInterval:p,liveDocument:f,channel:m,documentsCacheLastUpdated:h}=e,w=function(e){const t=r((()=>JSON.stringify(e||{})),[e]);return r((()=>JSON.parse(t)),[t])}(e.params),y=function(e){const{cache:t,liveDocument:n,client:i,refreshInterval:u,query:l,params:d,perspective:p,documentsCacheLastUpdated:f}=e,[m,h]=s(null),{projectId:w,dataset:y}=r((()=>{const{projectId:e,dataset:t}=i.config();return{projectId:e,dataset:t}}),[i]),[g,I]=s(null);if(g)throw g;const[L,b]=function(e){const{refreshInterval:t}=e,n=function(){const[e,t]=s(!1);o((()=>{t(navigator.onLine);const e=()=>t(!0),n=()=>t(!1);return window.addEventListener("online",e),window.addEventListener("offline",n),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",n)}}),[]);const n=c(v,(()=>document.visibilityState),(()=>"hidden"));return!e||"hidden"===n}(),[r,i]=s("hit"),u=a((()=>(i("inflight"),()=>i("hit"))),[]);return o((()=>{if(!t||"hit"!==r)return;const e=setTimeout((()=>i("stale")),t);return()=>clearTimeout(e)}),[t,r]),o((()=>{if("hit"!==r)return;const e=()=>i("stale");return window.addEventListener("focus",e),()=>window.removeEventListener("focus",e)}),[t,r]),o((()=>{n&&"hit"===r&&i("stale"),!n&&"stale"===r&&i("refresh")}),[n,r]),[r,u]}({refreshInterval:u}),D="refresh"===L||"inflight"===L;return o((()=>{if(!D)return;let e=!1,t=!1;const n=new AbortController;async function r(){const{signal:r}=n;t=!0;const{result:s,resultSourceMap:o}=await i.fetch(l,d,{tag:"presentation-loader",signal:r,perspective:p,filterResponse:!1});t=!1,r.aborted||(h({result:s,resultSourceMap:o}),e=!0)}const s=b();return r().catch((e=>{t=!1,"AbortError"!==e.name&&I(e)})).finally(s),()=>{!e&&!t&&n.abort()}}),[i,y,n,d,p,w,l,D,b]),r((()=>f&&null!=m&&m.resultSourceMap?{result:S(t,n,m.result,p,m.resultSourceMap),resultSourceMap:m.resultSourceMap}:m),[t,f,n,p,m])}({cache:t,client:d,liveDocument:f,params:w,perspective:u,query:l,refreshInterval:p,documentsCacheLastUpdated:h}),g=null==y?void 0:y.result,I=null==y?void 0:y.resultSourceMap;return o((()=>{I&&m.send("loaders","loader/query-change",{projectId:n,dataset:i,perspective:u,query:l,params:w,result:g,resultSourceMap:I})}),[m,i,w,u,n,l,g,I]),null}g.displayName="GetDocuments";let L=!1;function S(e,t,n,r,s){if("raw"===r)throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return u(n,s,(n=>{if(!n._projectId)return null!=t&&t._id&&l(t._id)===l(n._id)?t:e.get(n._id);L||(console.warn("Cross dataset references are not supported yet, ignoring source document",n),L=!0)}),((e,{previousValue:t})=>"number"==typeof e&&"string"==typeof t?`${e}`:e),r)}export{w as default,S as turboChargeResultIfSourceMap};//# sourceMappingURL=LoaderQueries.js.map
