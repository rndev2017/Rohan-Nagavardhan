"use strict";var e=Object.defineProperty,t=(t,n,r)=>((t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r)(t,"symbol"!=typeof n?n+"":n,r),n=require("react/jsx-runtime"),r=require("@sanity/client/csm"),i=require("@sanity/ui"),o=require("react"),s=require("sanity"),a=require("sanity/router"),c=require("styled-components"),l=require("./index.cjs"),u=require("@sanity/icons"),d=require("sanity/structure"),p=require("./DisplayedDocumentBroadcaster.cjs"),f=require("@sanity/preview-url-secret/without-secret-search-params"),m=require("framer-motion"),h=require("@sanity/preview-url-secret/create-secret"),v=require("fast-deep-equal"),g=require("path-to-regexp"),x=require("@sanity/preview-url-secret/define-preview-url"),y=require("suspend-react");function b(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var w=b(v);let j;const P=new Uint8Array(16);function k(){if(!j&&(j=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!j))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return j(P)}const S=[];for(let e=0;e<256;++e)S.push((e+256).toString(16).slice(1));var E={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function C(e,t,n){if(E.randomUUID&&!t&&!e)return E.randomUUID();const r=(e=e||{}).random||(e.rng||k)();return r[6]=15&r[6]|64,r[8]=63&r[8]|128,function(e,t=0){return S[e[t+0]]+S[e[t+1]]+S[e[t+2]]+S[e[t+3]]+"-"+S[e[t+4]]+S[e[t+5]]+"-"+S[e[t+6]]+S[e[t+7]]+"-"+S[e[t+8]]+S[e[t+9]]+"-"+S[e[t+10]]+S[e[t+11]]+S[e[t+12]]+S[e[t+13]]+S[e[t+14]]+S[e[t+15]]}(r)}const I=1e3,T=1e3,R=500,L=["handshake/syn","handshake/syn-ack","handshake/ack"],z=e=>L.some((t=>t===e)),D=({data:e={}})=>"object"==typeof e&&null!==e&&!Array.isArray(e)&&!("domain"in e)&&["id","type","from","to"].every((t=>t in e))&&e.type.startsWith("handshake/");function M(e){const t=e.target,n=e.connectTo.map((e=>({buffer:[],config:e,id:"",handler:i,status:"connecting",interval:void 0,heartbeat:void 0})));function r(e){window.clearInterval(e.interval)}function i(e){const{data:t}=e;if(z(t.type)){const e=n.find((e=>e.config.id===t.from));e&&"handshake/syn-ack"===t.type&&(c(e,"connected"),l(e,"handshake/ack",{id:e.id}))}}const o=t=>{var r,i,o;const s=t.data;if(!z(s.type)&&n.find((e=>e.id===s.connectionId))){const t=n.find((e=>e.config.id===s.from));if(t){const n=[s.type,s.data];null==(i=(r=t.config).onEvent)||i.call(r,...n),null==(o=e.onEvent)||o.call(e,...n),u(t,"channel/response",{responseTo:s.id},!1)}}};function s(t){var r;if(D(t))console.error("Visual editing package mismatch detected! Please ensure you are using the latest version of Sanity Studio and any packages listed here:\nhttps://github.com/sanity-io/visual-editing");else if(function(t){const{data:r,origin:i}=t;return"sanity/channels"===r.domain&&r.to==e.id&&n.map((e=>e.config.id)).includes(r.from)&&"channel/response"!==r.type&&i===e.targetOrigin}(t)){const{data:e}=t;null==(r=n.find((t=>t.config.id===e.from)))||r.handler(t)}}function a(e){e.heartbeat&&window.clearInterval(e.heartbeat)}function c(t,n){var s,c,d;t.status=n,null==(c=(s=t.config).onStatusUpdate)||c.call(s,n,t.config.id),null==(d=e.onStatusUpdate)||d.call(e,n,t.config.id),"connecting"===n||"reconnecting"===n?(t.handler=i,a(t),function(e){e.id=C(),e.interval=window.setInterval((()=>{l(e,"handshake/syn",{id:e.id})}),R)}(t)):"connected"===n?(t.handler=o,r(t),function(e){if(a(e),e.config.heartbeat){const t="number"==typeof e.config.heartbeat?e.config.heartbeat:T;e.heartbeat=window.setInterval((()=>{u(e,"channel/heartbeat")}),t)}}(t),function(e){const t=[...e.buffer];e.buffer.splice(0,e.buffer.length),t.forEach((({type:t,data:n})=>{u(e,t,n)}))}(t)):"disconnected"===n&&(t.id=null,t.handler=i,r(t),a(t))}function l(n,r,i){if(!n.id)throw new Error("No channel ID set");const o={connectionId:n.id,data:i,domain:"sanity/channels",from:e.id,id:C(),to:n.config.id,type:r};try{null==t||t.postMessage(o,{targetOrigin:"*"})}catch{throw new Error(`Failed to postMessage '${o.id}' on '${e.id}'`)}}function u(n,r,i,o=!0){const s=C();if("connecting"===n.status||"reconnecting"===n.status||"disconnected"===n.status)return void n.buffer.push({type:r,data:i});if(!n.id)throw new Error("No channel ID set");const a={connectionId:n.id,data:i,domain:"sanity/channels",from:e.id,id:s,to:n.config.id,type:r};if(o){const t=setTimeout((()=>{a.connectionId===n.id&&(window.removeEventListener("message",o,!1),"channel/heartbeat"!==r&&n.buffer.push({type:r,data:i}),c(n,"reconnecting"),console.warn(`Received no response to message '${a.type}' on client '${e.id}' (ID: '${a.id}').`))}),I),o=e=>{var n;const{data:r}=e;"channel/response"===r.type&&null!=(n=r.data)&&n.responseTo&&r.data.responseTo===a.id&&(window.removeEventListener("message",o,!1),clearTimeout(t))};window.addEventListener("message",o,!1)}try{null==t||t.postMessage(a,{targetOrigin:e.targetOrigin})}catch{throw new Error(`Failed to postMessage '${a.id}' on client '${e.id}'`)}}return window.addEventListener("message",s,!1),n.forEach((e=>{c(e,"connecting")})),{destroy:function(){n.forEach((e=>{["disconnected"].includes(e.status)||(u(e,"channel/disconnect",{id:e.id},!1),c(e,"disconnected"))})),window.removeEventListener("message",s,!1),n.forEach((e=>{a(e),r(e)}))},send:function(e,t,r){(e?Array.isArray(e)?[...e]:[e]:n).forEach((e=>{const i=n.find((t=>t.config.id===e));if(!i)throw new Error("Invalid channel ID");u(i,t,r)}))}}}var O,U,_,$,A=class extends Error{constructor(e){super(e[0].message),t(this,"issues"),this.name="ValiError",this.issues=e}};function F(e,t){return Array.isArray(e)?[void 0,e]:[e,t]}function B(e,t,n,r,i){var o,s,a,c,l;const u=null!=(l=null!=(c=null!=(a=null!=(s=null!=(o=t.message)?o:function(e,t){var n;return null==(n=null==$?void 0:$.get(e))?void 0:n.get(t)}(n,i.lang))?s:e?(d=i.lang,null==_?void 0:_.get(d)):null)?a:null==r?void 0:r.message)?c:function(e){return null==U?void 0:U.get(e)}(i.lang))?l:i.message;var d;return"function"==typeof u?u(i):u}function W(e,t,n){return{typed:e,output:t,issues:n}}function q(e){let t=typeof e;return"object"===t&&(t=e?Object.getPrototypeOf(e).constructor.name:"null"),"string"===t?`"${e}"`:"number"===t||"bigint"===t||"boolean"===t?`${e}`:t}function N(e,t,n){var r;const i=null!=(r=n.received)?r:q(n.input),o={reason:e.type,context:n.context.type,expected:n.context.expects,received:i,message:`Invalid ${n.label}: ${n.context.expects?`Expected ${n.context.expects} but r`:"R"}eceived ${i}`,input:n.input,requirement:n.context.requirement,path:n.path,lang:null==t?void 0:t.lang,abortEarly:null==t?void 0:t.abortEarly,abortPipeEarly:null==t?void 0:t.abortPipeEarly,skipPipe:null==t?void 0:t.skipPipe};return o.message=B(!1,n.context,n.reference,t,o),o}function K(e,t,n,r){if(e.pipe&&(null==n||!n.skipPipe))for(const i of e.pipe){const o=i._parse(t);if(o.issues){for(const t of o.issues){const i=N(e,n,t);r?r.push(i):r=[i]}if(null!=n&&n.abortEarly||null!=n&&n.abortPipeEarly)break}else t=o.output}return W(!0,t,r)}function V(e,t,n,r,i){var o,s;const a=q(n),c=null!=(o=null==i?void 0:i.expected)?o:e.expects,l={reason:null!=(s=null==i?void 0:i.reason)?s:"type",context:e.type,expected:c,received:a,message:`Invalid type: Expected ${c} but received ${a}`,input:n,path:null==i?void 0:i.path,issues:null==i?void 0:i.issues,lang:null==r?void 0:r.lang,abortEarly:null==r?void 0:r.abortEarly,abortPipeEarly:null==r?void 0:r.abortPipeEarly,skipPipe:null==r?void 0:r.skipPipe};return l.message=B(!0,e,t,r,l),{typed:!1,output:n,issues:[l]}}function G(e,t){return{...e,fallback:t,_parse(t,n){const r=e._parse(t,n);return r.issues?W(!0,function(e,t){return"function"==typeof e.fallback?e.fallback(t):e.fallback}(this,{input:t,issues:r.issues})):r}}}function J(e,t){const[n,r]=F(e,t);return{type:"boolean",expects:"boolean",async:!1,message:n,pipe:r,_parse(e,t){return"boolean"==typeof e?K(this,e,t):V(this,J,e,t)}}}function H(e,t,n,r){const[i,o,s]=function(e,t,n){if(!e||"object"==typeof e&&!Array.isArray(e)){const[r,i]=F(t,n);return[e,r,i]}const[r,i]=F(e,t);return[void 0,r,i]}(t,n,r);let a;return{type:"object",expects:"Object",async:!1,entries:e,rest:i,message:o,pipe:s,_parse(e,t){if(e&&"object"==typeof e){a=null!=a?a:Object.entries(this.entries);let n,r=!0;const i={};for(const[o,s]of a){const a=e[o],c=s._parse(a,t);if(c.issues){const i={type:"object",origin:"value",input:e,key:o,value:a};for(const e of c.issues)e.path?e.path.unshift(i):e.path=[i],null==n||n.push(e);if(n||(n=c.issues),null!=t&&t.abortEarly){r=!1;break}}c.typed||(r=!1),(void 0!==c.output||o in e)&&(i[o]=c.output)}if(this.rest&&(null==t||!t.abortEarly||!n))for(const o in e)if(!(o in this.entries)){const s=e[o],a=this.rest._parse(s,t);if(a.issues){const i={type:"object",origin:"value",input:e,key:o,value:s};for(const e of a.issues)e.path?e.path.unshift(i):e.path=[i],null==n||n.push(e);if(n||(n=a.issues),null!=t&&t.abortEarly){r=!1;break}}a.typed||(r=!1),i[o]=a.output}return r?K(this,i,t,n):W(!1,i,n)}return V(this,H,e,t)}}}function X(e,t){return{type:"picklist",expects:e.map(q).join(" | "),async:!1,options:e,message:t,_parse(e,t){return this.options.includes(e)?W(!0,e):V(this,X,e,t)}}}function Z(e,t,n){const r=e._parse(t,function(e){var t,n,r,i;return{lang:null!=(t=null==e?void 0:e.lang)?t:null==O?void 0:O.lang,message:null==e?void 0:e.message,abortEarly:null!=(n=null==e?void 0:e.abortEarly)?n:null==O?void 0:O.abortEarly,abortPipeEarly:null!=(r=null==e?void 0:e.abortPipeEarly)?r:null==O?void 0:O.abortPipeEarly,skipPipe:null!=(i=null==e?void 0:e.skipPipe)?i:null==O?void 0:O.skipPipe}}(n));if(r.issues)throw new A(r.issues);return r.output}const Q=/^([A-Za-z]+):([0-9]+)$/,Y=/^([A-Za-z]+):([0-9]+),([0-9]+)$/,ee=/^([A-Za-z]+):([a-z0-9]+)$/;function te(e,t){return`${e}-${"string"==typeof t?t:JSON.stringify(t)}`}const ne={alt:"altKey",ctrl:"ctrlKey",mod:typeof window<"u"&&/Mac|iPod|iPhone|iPad/.test(window.navigator.platform)?"metaKey":"ctrlKey",shift:"shiftKey"};function re(e){return"Alt"===e.key}function ie(e,t){let n;return(...r)=>{clearTimeout(n),n=setTimeout((()=>{e.apply(e,r)}),t)}}const oe=o.createContext(null);oe.displayName="PanelsContext";const se=c.styled.div`
  overflow: hidden;
  flex-basis: 0;
  flex-shrink: 1;
`,ae=function({children:e,defaultSize:t=null,id:r,minWidth:i,maxWidth:s,order:a=0}){const c=o.useContext(oe);if(null===c)throw Error("Panel components must be rendered within a PanelGroup container");const{getPanelStyle:l,registerElement:u,unregisterElement:d}=c,p=l(r);return o.useLayoutEffect((()=>(u(r,{id:r,type:"panel",defaultSize:t,maxWidth:null!=s?s:null,minWidth:null!=i?i:0,order:a}),()=>{d(r)})),[r,t,a,s,i,u,d]),n.jsx(se,{style:p,children:e})},ce="presentation/panels",le=()=>JSON.parse(localStorage.getItem(ce)||"{}"),ue=e=>e.map((e=>[e.id,e.order].join(":"))).join(",");function de(){return o.useMemo((()=>{const e=(e,t)=>{const n=le(),r=ue(e);(e=>{localStorage.setItem(ce,JSON.stringify(e))})({...n,[r]:t})};return{get:e=>{const t=le(),n=ue(e);return Array.isArray(t[n])&&t[n].some((e=>null===e))?void 0:t[n]},set:e,setDebounced:ie(e,100)}}),[])}function pe(e,t,n){const{maxWidth:r,minWidth:i}=e,o=null==r?100:r/n*100,s=i/n*100;return Math.min(o,Math.max(s,t))}function fe(e,t,n){if(1===e.length)return"100";const r=n[e.findIndex((e=>e.id===t))];return null==r?"0":r.toPrecision(10)}function me(e,t,n=0,r=null){return e.clientX-(r||t.getBoundingClientRect()).left-n}function he(e){return"panel"===e.type}function ve(e){return"resizer"===e.type}function ge(e){return Array.from(e.values()).sort((({order:e},{order:t})=>null==e&&null==t?0:null==e?-1:null==t?1:e-t))}function xe(e,t,n){const r=t.reduce(((e,t)=>e+t),0),i=[...t].map((e=>e/r*100));let o=0;for(let t=0;t<e.length;t++){const r=e[t],s=i[t],a=pe(r,s,n);s!=a&&(o+=s-a,i[t]=a)}if("0.000"!==o.toFixed(3))for(let t=0;t<e.length;t++){const r=e[t];let{maxWidth:s,minWidth:a}=r;a=a/n*100,null!=s&&(s=s/n*100);const c=Math.min(null!=s?s:100,Math.max(a,i[t]+o));if(c!==i[t]&&(o-=c-i[t],i[t]=c,"0.000"===Math.abs(o).toFixed(3)))break}return i}const ye=c.styled.div`
  display: flex;
  flex-direction: row;
  height: 100%;
  overflow: hidden;
  width: 100%;
`,be=function({children:e}){const t=o.useRef(null),[r,i]=o.useState(new Map),s=o.useMemo((()=>ge(r).filter(he)),[r]),[a,c]=o.useState([]),[l,u]=o.useState(null),d=o.useRef({elements:r,panels:s,widths:a}),p=o.useCallback((e=>({flexGrow:fe(s,e,a),pointerEvents:null===l?void 0:"none"})),[l,s,a]),f=o.useCallback(((e,t)=>{i((n=>{if(n.has(e))return n;const r=new Map(n);return r.set(e,t),r}))}),[]),m=o.useCallback((e=>{i((t=>{if(!t.has(e))return t;const n=new Map(t);return n.delete(e),n}))}),[]),h=o.useRef({containerWidth:window.innerWidth,dragOffset:0,panelAfter:null,panelBefore:null,resizerIndex:-1,resizerRect:null,startX:0,widths:[]}),v=o.useCallback(((e,t)=>{const n=ge(r),i=n.findIndex((t=>t.id===e)),o=r.get(e);if(!o||!ve(o))return;const s=o.el.current;s&&(h.current={resizerIndex:i,panelBefore:n.reduce(((e,t,n)=>he(t)&&n<i?t:e),null),panelAfter:n.reduce(((e,t,n)=>null===e&&he(t)&&n>i?t:e),null),containerWidth:window.innerWidth,startX:t.pageX,dragOffset:me(t,s),resizerRect:s.getBoundingClientRect(),widths:d.current.widths},u(e))}),[r]),g=o.useCallback((()=>{u(null)}),[]),x=o.useCallback(((e,n)=>{n.preventDefault(),n.stopPropagation();const{containerWidth:i,dragOffset:o,panelBefore:s,panelAfter:a,resizerRect:l}=h.current;if(null==s||null==a)return;const u=r.get(e);if(!u||!ve(u))return;const p=u.el.current;if(!p)return;const f=me(n,p,o,l);if(0===f)return;const{widths:m}=d.current,v=function(e,t,n,r,i,o){const{panels:s,widths:a}=i,{widths:c}=o,l=c||a,u=[...l];{const i=e<0?r:n,o=l[s.findIndex((e=>e.id===i.id))],a=pe(i,o+Math.abs(e),t);if(o===a)return l;e=e<0?o-a:a-o}let d=0,p=e<0?n:r,f=s.findIndex((e=>e.id===p.id));for(;;){const n=s[f],r=l[f],i=pe(n,r-(Math.abs(e)-Math.abs(d)),t);if(r!==i&&(d+=r-i,u[f]=i,d.toPrecision(10).localeCompare(Math.abs(e).toPrecision(10),void 0,{numeric:!0})>=0))break;if(e<0){if(--f<0)break}else if(++f>=s.length)break}return 0===d?l:(p=e<0?r:n,f=s.findIndex((e=>e.id===p.id)),u[f]=l[f]+d,u)}(f/t.current.getBoundingClientRect().width*100,i,s,a,d.current,h.current);m.some(((e,t)=>e!==v[t]))&&c(v)}),[r]);o.useLayoutEffect((()=>{d.current.elements=r,d.current.panels=s,d.current.widths=a}),[r,s,a]);const y=de();o.useLayoutEffect((()=>{const{widths:e}=d.current;if(e.length===s.length)return;const t=y.get(s);if(t){const e=xe(s,t,window.innerWidth);return void c(e)}const n=function(e){let t=e.length,n=100;const r=e.map((e=>e.defaultSize?(n-=e.defaultSize,t-=1,e.defaultSize):null)),i=n/t;return r.map((e=>null===e?i:e))}(s);c(n)}),[y,s]),o.useEffect((()=>{a.length&&y.setDebounced(s,a)}),[y,s,a]),o.useLayoutEffect((()=>{const e=new ResizeObserver((()=>{const{panels:e,widths:t}=d.current,n=xe(e,t,window.innerWidth);t.some(((e,t)=>e!==n[t]))&&c(n)}));return e.observe(t.current),()=>{e.disconnect()}}),[]);const b=o.useMemo((()=>({activeResizer:l,drag:x,getPanelStyle:p,registerElement:f,startDragging:v,stopDragging:g,unregisterElement:m})),[l,x,p,f,v,g,m]);return n.jsx(oe.Provider,{value:b,children:n.jsx(ye,{ref:t,children:e})})};function we(e){const{children:t,message:r,onRetry:o,onContinueAnyway:a,...c}=e,{t:u}=s.useTranslation(l.p),d=n.jsx(i.Button,{fontSize:1,mode:"ghost",onClick:o,text:u("error-card.retry-button.text")}),p=n.jsx(i.Button,{fontSize:1,mode:"ghost",tone:"critical",onClick:a,text:u("error-card.continue-button.text")});return n.jsx(i.Card,{height:"fill",...c,children:n.jsx(i.Flex,{align:"center",height:"fill",justify:"center",children:n.jsx(i.Container,{padding:4,sizing:"border",width:0,children:n.jsxs(i.Stack,{space:4,children:[n.jsxs(i.Stack,{space:3,children:[n.jsx(i.Text,{size:1,weight:"semibold",children:u("error-card.title")}),n.jsx(i.Text,{muted:!0,size:1,children:r})]}),t,o&&a?n.jsxs(i.Inline,{space:2,children:[d,p]}):o?n.jsx(i.Box,{children:d}):a?n.jsx(i.Box,{children:p}):null]})})})})}function je(e){const t=["comment","inspect","instruction","pathKey","rev","since","template","prefersLatestPublished","view"];return function(e={}){const t=Object.entries(e).map((([e,t])=>`${e}=${t}`)).join("&");return t.length?`?${t}`:""}(Object.entries(e).filter((([e])=>t.includes(e))).reduce(((e,[t,n])=>null==n?e:{...e,[t]:n}),{}))}const Pe=o.forwardRef((function(e,t){const{params:r,structureParams:i}=l.u();return n.jsx(a.StateLink,{...e,ref:t,state:{type:void 0,_searchParams:Object.entries({...i,perspective:r.perspective,preview:r.preview})},title:void 0})})),ke=o.forwardRef((function(e,t){const{documentId:r,documentType:i,parentRefPath:o,template:s,previewUrl:c,...u}=e,{params:d}=l.u();return n.jsx(a.StateLink,{...u,ref:t,state:{id:r,type:i,_searchParams:Object.entries({preview:c,prefersLatestPublished:"published"===d.perspective?"true":void 0})},title:void 0})}));function Se(e){const{children:t,onStructureParams:r,params:i,previewUrl:c,refs:u}=e,{state:p,resolvePathFromState:f}=a.useRouter(),m=s.useUnique(Object.fromEntries(p._searchParams||[])),h=o.useCallback((e=>`${f(p)}${je({...m,...e})}`),[f,m,p]),v=o.useMemo((()=>({index:0,groupIndex:0,siblingIndex:0,payload:{},params:i,hasGroupSiblings:!1,groupLength:1,routerPanesState:[],ChildLink:e=>{const{childId:t,...r}=e,i=null==u?void 0:u.find((e=>e._id===t||s.getPublishedId(e._id)===t)),{params:o}=l.u();return i?n.jsx(a.StateLink,{...r,state:{id:t,type:i._type,_searchParams:Object.entries({preview:c,prefersLatestPublished:"published"===o.perspective?"true":void 0})}}):n.jsx("div",{...r})},BackLink:Pe,ReferenceChildLink:e=>n.jsx(ke,{...e,previewUrl:c}),ParameterizedLink:()=>n.jsx(n.Fragment,{children:"ParameterizedLink"}),closeCurrentAndAfter:()=>{console.warn("closeCurrentAndAfter")},handleEditReference:e=>{console.warn("handleEditReference",e)},replaceCurrent:e=>{console.warn("replaceCurrent",e)},closeCurrent:()=>{console.warn("closeCurrent")},duplicateCurrent:e=>{console.warn("duplicateCurrent",e)},setView:e=>{console.warn("setView",e)},setParams:e=>{var t;r({...e,inspect:null!=(t=e.inspect)?t:void 0})},setPayload:e=>{console.warn("setPayload",e)},navigateIntent:(e,t,n)=>{console.warn("navigateIntent",e,t,n)},createPathWithParams:h})),[h,r,i,c,u]);return n.jsx(d.PaneRouterContext.Provider,{value:v,children:t})}const Ee=c.styled(d.PaneLayout)`
  height: 100%;
`,Ce=c.styled(i.Flex)`
  & > div {
    min-width: none !important;
    max-width: none !important;
  }
`,Ie=c.styled(i.Code)`
  white-space: pre-wrap;
`;function Te(e){const{mainDocumentState:t,onStructureParams:r,previewUrl:a,refs:c}=e,{t:u}=s.useTranslation(l.p),{devMode:p}=l.u(),f=o.useMemo((()=>c.filter((e=>{var n;return s.getPublishedId(e._id)!==(null==(n=null==t?void 0:t.document)?void 0:n._id)})).map((e=>e._id))),[t,c]),m=o.useMemo((()=>({id:"$root",options:{filter:"_id in $ids",params:{ids:f}},schemaTypeName:"",title:u("document-list-pane.document-list.title"),type:"documentList"})),[f,u]),[h,v]=o.useState(null),g=o.useCallback((()=>v(null)),[]),[x]=o.useState((()=>({})));return o.useEffect((()=>v(null)),[c]),h?n.jsx(we,{flex:1,message:u("document-list-pane.error.text"),onRetry:g,children:p&&n.jsx(i.Card,{overflow:"auto",padding:3,radius:2,tone:"critical",children:n.jsxs(i.Stack,{space:3,children:[n.jsx(i.Label,{muted:!0,size:0,children:u("presentation-error.label")}),n.jsx(Ie,{size:1,children:h.error.message})]})})}):n.jsx(i.ErrorBoundary,{onCatch:v,children:n.jsx(Ee,{children:n.jsx(d.StructureToolProvider,{children:n.jsx(Se,{onStructureParams:r,params:x,previewUrl:a,refs:c,children:n.jsx(Ce,{direction:"column",flex:1,children:n.jsx(d.DocumentListPane,{index:0,itemId:"$root",pane:m,paneKey:"$root"})})})})})})}const Re=c.styled(i.Code)`
  white-space: pre-wrap;
`;function Le(e){const{documentId:t,documentType:r,onFocusPath:c,onStructureParams:u,params:p,previewUrl:f}=e,{template:m,templateParams:h}=p,{t:v}=s.useTranslation(l.p),{devMode:g}=l.u(),x=o.useMemo((()=>({id:t,options:{id:t,type:r,template:m,templateParameters:a.decodeJsonParams(h)},title:"",type:"document"})),[t,r,m,h]),[y,b]=o.useState(null),w=o.useCallback((()=>b(null)),[]);return o.useEffect((()=>{b(null)}),[t,r,p]),y?n.jsx(we,{flex:1,message:v("document-pane.error.text"),onRetry:w,children:g&&n.jsx(i.Card,{overflow:"auto",padding:3,radius:2,tone:"critical",children:n.jsxs(i.Stack,{space:3,children:[n.jsx(i.Label,{muted:!0,size:0,children:v("presentation-error.label")}),n.jsx(Re,{size:1,children:y.error.message})]})})}):n.jsx(i.ErrorBoundary,{onCatch:b,children:n.jsx(d.PaneLayout,{style:{height:"100%"},children:n.jsx(Se,{onStructureParams:u,params:p,previewUrl:f,children:n.jsx(d.DocumentPane,{paneKey:"document",index:1,itemId:"document",pane:x,onFocusPath:c})})})})}function ze(e){const{documentId:t,documentType:r,onFocusPath:i,onStructureParams:o,previewUrl:s,structureParams:a}=e;return n.jsx(d.StructureToolProvider,{children:n.jsx(Le,{documentId:t,documentType:r,onFocusPath:i,onStructureParams:o,params:a,previewUrl:s})})}function De(e){const{documentId:t,documentType:r,mainDocumentState:c,onFocusPath:d,onStructureParams:p,previewUrl:f,refs:m,structureParams:h}=e,{t:v}=s.useTranslation(l.p),g=s.useSchema(),x=o.useCallback((e=>n.jsx(a.StateLink,{...e,state:{id:c.document._id,type:c.document._type,_searchParams:Object.entries({preview:f})}})),[c,f]);return t&&r?n.jsx(ze,{documentId:t,documentType:r,onFocusPath:d,onStructureParams:p,previewUrl:f,structureParams:h}):n.jsxs(i.Flex,{direction:"column",flex:1,height:"fill",children:[c&&n.jsx(i.Card,{padding:3,tone:c.document?"inherit":"caution",children:c.document?n.jsx(i.Card,{as:x,"data-as":"a",padding:0,radius:2,children:n.jsx(s.Preview,{schemaType:g.get(c.document._type),status:n.jsx(i.Badge,{children:v("main-document.label")}),value:c.document})}):n.jsx(i.Card,{padding:2,radius:2,tone:"inherit",children:n.jsxs(i.Flex,{gap:3,children:[n.jsx(i.Box,{flex:"none",children:n.jsx(i.Text,{size:1,children:n.jsx(u.WarningOutlineIcon,{})})}),n.jsx(i.Box,{flex:1,children:n.jsx(i.Text,{size:1,children:n.jsx(s.Translate,{t:v,i18nKey:"main-document.missing.text",components:{Code:"code"},values:{path:c.path}})})})]})})}),n.jsx(Te,{mainDocumentState:c,onStructureParams:p,previewUrl:f,refs:m})]})}const Me=c.styled.div`
  position: relative;
`,Oe=c.styled.div`
  position: absolute;
  top: 0;
  bottom: 0;
  left: -5px;
  width: 9px;
  z-index: 10;
  cursor: ${({$disabled:e})=>e?"auto":"ew-resize"};

  /* Border */
  & > span:nth-child(1) {
    display: block;
    border-left: 1px solid var(--card-border-color);
    position: absolute;
    top: 0;
    left: 4px;
    bottom: 0;
    transition: opacity 200ms;
  }

  ${({$disabled:e})=>!e&&"\n    /* Hover effect */\n    & > span:nth-child(2) {\n      display: block;\n      position: absolute;\n      top: 0;\n      left: 0;\n      width: 9px;\n      bottom: 0;\n      background-color: var(--card-border-color);\n      opacity: 0;\n      transition: opacity 150ms;\n    }\n\n    @media (hover: hover) {\n      &:hover > span:nth-child(2) {\n        opacity: 0.2;\n      }\n    }\n  "}
`,Ue=function({id:e,order:t,disabled:r=!1}){const i=o.useRef(null),s=o.useContext(oe);if(null===s)throw Error("Panel components must be rendered within a PanelGroup container");const a=function(e){return o.useRef(e||C()).current}(e),{activeResizer:c,drag:l,startDragging:u,stopDragging:d,registerElement:p,unregisterElement:f}=s,m=c===a;if(null===s)throw Error("Panel components must be rendered within a PanelGroup container");const h=o.useCallback((e=>{u(a,e.nativeEvent)}),[a,u]),v=o.useCallback((e=>{l(a,e)}),[a,l]),g=o.useCallback((()=>{i.current.blur(),d()}),[d]);return o.useEffect((()=>{if(m&&!r)return window.addEventListener("mousemove",v),window.addEventListener("mouseup",g),()=>{window.removeEventListener("mousemove",v),window.removeEventListener("mouseup",g)}}),[r,m,v,g]),o.useLayoutEffect((()=>(p(a,{id:a,order:t,type:"resizer",el:i}),()=>{f(a)})),[a,t,p,f]),n.jsx(Me,{onMouseDown:h,ref:i,children:n.jsxs(Oe,{$disabled:r,children:[n.jsx("span",{}),n.jsx("span",{})]})})},_e=e=>{const{documentId:t,setDisplayedDocument:r,getCommentIntent:i}=e;return n.jsxs(n.Fragment,{children:[n.jsx(Ue,{order:4}),n.jsx(ae,{id:"content",minWidth:325,order:5,children:n.jsx(p.D,{documentId:t,setDisplayedDocument:r,children:n.jsx(s.CommentsIntentProvider,{getIntent:i,children:e.children})})})]})},$e=e=>{const{documentsOnPage:t,getCommentIntent:r,mainDocumentState:i,onFocusPath:o,onStructureParams:s,params:a,setDisplayedDocument:c,structureParams:l}=e;return n.jsx(_e,{documentId:a.id,getCommentIntent:r,setDisplayedDocument:c,children:n.jsx(De,{documentId:a.id,documentType:a.type,mainDocumentState:i,onFocusPath:o,onStructureParams:s,previewUrl:a.preview,refs:t,structureParams:l})})},Ae=function(e){const{children:t,navigate:r}=e,i=o.useCallback(((e,t=void 0)=>{r(t||{},e?{preview:e}:{})}),[r]);return n.jsx(l.P.Provider,{value:i,children:t})};function Fe(e){const{unstable_navigator:t}=e,r=!(null==t||!t.component),[i,s]=function(e,t){const[n,r]=o.useState((()=>{var n;return JSON.parse(null!=(n=localStorage.getItem(e))?n:JSON.stringify(t))}));return o.useEffect((()=>{localStorage.setItem(e,JSON.stringify(n))}),[e,n]),[n,r]}("presentation/navigator",r),a=!!r&&i,c=o.useMemo((()=>{if(r)return()=>s((e=>!e))}),[r,s]),l=o.useCallback((function(){return n.jsx(n.Fragment,{children:a&&n.jsx(Be,{...t})})}),[a,t]);return[{navigatorEnabled:a,toggleNavigator:c},l]}const Be=o.memo((function(e){const{minWidth:t,maxWidth:r,component:i}=e,o=null!=t&&null!=r&&t===r;return n.jsxs(n.Fragment,{children:[n.jsx(ae,{id:"navigator",minWidth:t,maxWidth:r,order:1,children:n.jsx(i,{})}),n.jsx(Ue,{order:2,disabled:o})]})})),We=function(e){const{children:t,params:r}=e,i=o.useMemo((()=>r),[r]);return n.jsx(l.a.Provider,{value:i,children:t})},qe=function(e){const{children:t,devMode:r,name:i,navigate:s,params:a,structureParams:c}=e,u=o.useMemo((()=>({devMode:r,name:i,navigate:s,params:a,structureParams:c})),[r,i,s,a,c]);return n.jsx(l.b.Provider,{value:u,children:t})},Ne="ACTION_IFRAME_LOADED",Ke="ACTION_IFRAME_REFRESH",Ve="ACTION_IFRAME_RELOAD",Ge="ACTION_PERSPECTIVE",Je="ACTION_VIEWPORT",He="ACTION_VISUAL_EDITING_OVERLAYS_TOGGLE",Xe=(e,t)=>{switch(t.type){case Ne:return"loaded"===e.iframe.status?e:{...e,iframe:{...e.iframe,status:"loaded"}};case Ke:return"refreshing"===e.iframe.status?e:{...e,iframe:{...e.iframe,status:"refreshing"}};case Ve:return"reloading"===e.iframe.status?e:{...e,iframe:{...e.iframe,status:"reloading"}};case Ge:return{...e,perspective:Z(et,t.perspective)};case Je:return{...e,viewport:Z(tt,t.viewport)};case He:return Ze(e,t);default:return e}},Ze=(e,t)=>e.visualEditing.overlaysEnabled===t.enabled?e:{...e,visualEditing:{...e.visualEditing,overlaysEnabled:t.enabled}},Qe=G(J(),!1),Ye=X(["loading","loaded","refreshing","reloading"]),et=G(X(["published","previewDrafts"]),"previewDrafts"),tt=G(X(["desktop","mobile"]),"desktop"),nt=H({mainDocument:Qe,iframe:H({status:Ye}),perspective:et,viewport:tt,visualEditing:H({overlaysEnabled:J()})}),rt={mainDocument:!1,iframe:{status:"loading"},perspective:"previewDrafts",viewport:"desktop",visualEditing:{overlaysEnabled:!1}};function it(e){return Z(nt,{...rt,...e})}const ot=m.motion(c.styled.iframe`
  border: 0;
  max-height: 100%;
  width: 100%;
  display: block;
`),st=function(e){var t;const{fontSize:r=1,onChange:a,origin:c,padding:d=3,prefix:p,suffix:f,value:m}=e,{t:h}=s.useTranslation(l.p),{basePath:v="/"}=(null==(t=s.useActiveWorkspace())?void 0:t.activeWorkspace)||{},g=o.useRef(null),[x,y]=o.useState(void 0),[b,w]=o.useState(void 0),j=o.useCallback((e=>{y(e.currentTarget.value)}),[]),P=o.useCallback((e=>{var t;if("Enter"===e.key){if(void 0===x)return;const e=x.startsWith("/")||""===x?`${c}${x}`:x;if(!e.startsWith(c+"/")&&e!==c)return void w(h("preview-location-input.error",{origin:c,context:"missing-origin"}));if(!c&&(e.startsWith(`${v}/`)||e===v))return void w(h("preview-location-input.error",{basePath:v,context:"same-base-path"}));const n=e===c?c+"/":e;w(void 0),y(void 0),a(n.slice(c.length)),null==(t=g.current)||t.blur()}"Escape"===e.key&&(w(void 0),y(void 0))}),[v,a,c,x,h]),k=o.useCallback((()=>{w(void 0),y(void 0)}),[]);o.useEffect((()=>{w(void 0),y(void 0)}),[c,m]);const S=o.useMemo((()=>({icon:u.ResetIcon})),[]);return n.jsx(n.Fragment,{children:n.jsx(i.TextInput,{clearButton:b?S:void 0,customValidity:b,fontSize:r,onBlur:k,onClear:()=>{w(void 0),y(c+m)},onChange:j,onKeyDownCapture:P,padding:d,prefix:p,style:{zIndex:1},radius:2,ref:g,space:d,suffix:f,value:void 0===x?`${c}${m}`:x})})};function at(e){const{initialUrl:t,openPopup:r,previewLocationOrigin:a,previewLocationRoute:c}=e,{t:d}=s.useTranslation(l.p),p=o.useCallback((e=>{e.preventDefault(),r(e.currentTarget.href)}),[r]);return n.jsxs(n.Fragment,{children:[n.jsx(ct,{initialUrl:t,previewLocationOrigin:a,previewLocationRoute:c}),n.jsx(i.MenuItem,{icon:u.LaunchIcon,text:d("share-url.menu-item.open.text"),as:"a",href:`${a}${c}`,onClick:p,rel:"opener",target:"_blank"})]})}function ct(e){const{initialUrl:t,previewLocationOrigin:r,previewLocationRoute:a}=e,{t:c}=s.useTranslation(l.p),{push:d}=i.useToast(),p=s.useClient({apiVersion:l.A}),m=s.useCurrentUser(),[v,g]=o.useState(!1);return n.jsx(i.MenuItem,{disabled:v,onClick:()=>{if(null==navigator||!navigator.clipboard)return d({closable:!0,status:"error",title:c("share-url.clipboard.status",{context:"unsupported"})}),!1;g(!0);let e,n=`${r}${a}`;const i=()=>{d({id:e,closable:!0,status:"success",title:c("share-url.clipboard.status",{context:"success"})}),g(!1)},o=e=>{d({closable:!0,status:"error",title:c("share-url.clipboard.status",{context:"failed"}),description:e.message||e.toString()}),g(!1)};if(f.hasSecretSearchParams(t)&&typeof ClipboardItem<"u"){const r="text/plain",s=async()=>{e=d({closable:!0,title:c("share-url.clipboard.status",{context:"copying"})});const i=await h.createPreviewSecret(p,"@sanity/presentation",typeof window>"u"?"":location.href,null==m?void 0:m.id);return n=f.setSecretSearchParams(t,i.secret,a).toString(),new Blob([n],{type:r})},l=new ClipboardItem({[r]:s()});navigator.clipboard.write([l]).then(i).catch(o)}else navigator.clipboard.writeText(n).then(i).catch(o)},text:c("share-url.menu-item.copy.text"),icon:u.CopyIcon})}const lt=m.motion(i.Flex),ut={previewDrafts:"preview-frame.perspective.previewDrafts.title",published:"preview-frame.perspective.published.title"},dt="caution",pt="positive",ft={previewDrafts:u.EditIcon,published:u.PublishIcon},mt=o.forwardRef((function(e,t){const{dispatch:r,iframe:a,initialUrl:c,loadersConnection:d,navigatorEnabled:p,onPathChange:h,onRefresh:v,openPopup:g,overlaysConnection:x,params:y,perspective:b,targetOrigin:w,toggleNavigator:j,toggleOverlay:P,viewport:k,visualEditing:{overlaysEnabled:S}}=e,{t:E}=s.useTranslation(l.p),{devMode:C}=l.u(),I=i.usePrefersReducedMotion(),T=o.useCallback((()=>r({type:Je,viewport:"desktop"})),[r]),R=o.useCallback((()=>r({type:Je,viewport:"mobile"})),[r]),L="loading"===a.status||"reloading"===a.status,[z,D]=o.useState(!1),M="refreshing"===a.status,[O,U]=o.useState(!1),_=L||M||"connecting"===x,$=o.useMemo((()=>w===location.origin?"":w),[w]),A=o.useCallback((()=>{v((()=>{"function"==typeof t||null==t||!t.current||(r({type:Ve}),t.current.src=`${w}${y.preview||"/"}`)}))}),[r,v,y.preview,w,t]),F=o.useCallback((()=>{"function"==typeof t||null==t||!t.current||(t.current.src=c.toString(),r({type:Ve}))}),[r,t,c]),B=o.useCallback((()=>{q(!0)}),[]),[W,q]=o.useState(!1),[N,K]=o.useState(!1);o.useEffect((()=>{if(!(L||M||"connecting"!==x&&"reconnecting"!==x)){const e=setTimeout((()=>{K(!0)}),1e3);return()=>clearTimeout(e)}}),[x,L,M]),o.useEffect((()=>{if(!L&&!M&&N){if("connected"===x&&(U(!1),K(!1),D(!1),q(!1)),"connecting"===x){const e=setTimeout((()=>{D(!0),console.error("Unable to connect to visual editing. Make sure you've setup '@sanity/visual-editing' correctly")}),l.M);return()=>clearTimeout(e)}if("reconnecting"===x){const e=setTimeout((()=>{D(!0),U(!0)}),l.M);return()=>clearTimeout(e)}"disconnected"===x&&U(!0)}}),[L,x,M,N]);const V=o.useMemo((()=>{const e=new URL(y.preview||"/",w),{pathname:t,search:n}=f.withoutSecretSearchParams(e);return`${t}${n}`}),[y.preview,w]),G=o.useCallback((()=>{r({type:Ne})}),[r]);return o.useEffect((()=>{if("function"==typeof t||null==t||!t.current)return;const e=t.current;function n(){e===document.activeElement&&e.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0,cancelable:!0}))}return window.addEventListener("blur",n),()=>{window.removeEventListener("blur",n)}}),[t]),n.jsx(m.MotionConfig,{transition:I?{duration:0}:void 0,children:n.jsxs(i.TooltipDelayGroupProvider,{delay:1e3,children:[n.jsx(i.Card,{flex:"none",padding:2,shadow:1,style:{position:"relative"},children:n.jsxs(i.Flex,{align:"center",style:{minHeight:0},children:[j&&n.jsx(i.Box,{flex:"none",marginRight:1,padding:1,children:n.jsx(i.Tooltip,{animate:!0,content:n.jsx(i.Text,{size:1,children:E("preview-frame.navigator.toggle-button.tooltip")}),fallbackPlacements:["bottom-start"],padding:2,placement:"bottom",portal:!0,children:n.jsx(i.Button,{"aria-label":E("preview-frame.navigator.toggle-button.aria-label"),fontSize:1,icon:u.PanelLeftIcon,mode:"bleed",onClick:j,padding:2,selected:p})})}),n.jsx(i.Tooltip,{animate:!0,content:n.jsxs(i.Flex,{align:"center",style:{whiteSpace:"nowrap"},children:[n.jsx(i.Box,{padding:1,children:n.jsx(i.Text,{size:1,children:E("preview-frame.overlay.toggle-button.tooltip",{context:S?"disable":"enable"})})}),n.jsx(i.Box,{paddingY:1,children:n.jsx(s.Hotkeys,{keys:["Alt"],style:{marginTop:-4,marginBottom:-4}})})]}),fallbackPlacements:["bottom-start"],padding:1,placement:"bottom",portal:!0,children:n.jsx(i.Card,{as:"label",flex:"none",marginRight:1,padding:3,style:{lineHeight:0,borderRadius:999,userSelect:"none"},tone:S?"transparent":void 0,children:n.jsxs(i.Flex,{align:"center",gap:3,children:[n.jsx("div",{style:{margin:-4},children:n.jsx(i.Switch,{checked:S,onChange:P,disabled:"loading"===a.status||"connected"!==x})}),n.jsx(i.Box,{children:n.jsx(i.Text,{muted:!S,size:1,weight:"medium",children:E("preview-frame.overlay.toggle-button.text")})})]})})}),n.jsx(i.Box,{flex:1,marginX:1,children:n.jsx(st,{prefix:n.jsx(i.Box,{padding:1,children:n.jsx(i.Tooltip,{animate:!0,content:n.jsx(i.Text,{size:1,children:"loaded"===a.status?E("preview-frame.refresh-button.tooltip"):E("preview-frame.status",{context:a.status})}),fallbackPlacements:["bottom-start"],padding:2,placement:"bottom",portal:!0,children:n.jsx(i.Button,{"aria-label":E("preview-frame.refresh-button.aria-label"),fontSize:1,icon:u.RefreshIcon,mode:"bleed",loading:"reloading"===a.status||"refreshing"===a.status,onClick:A,padding:2})})}),onChange:h,origin:$,suffix:n.jsx(i.Box,{padding:1,children:n.jsx(i.MenuButton,{button:n.jsx(i.Button,{fontSize:1,iconRight:u.ShareIcon,mode:"bleed",padding:2,space:2}),id:"location-menu",menu:n.jsx(i.Menu,{children:n.jsx(at,{initialUrl:c,openPopup:g,previewLocationOrigin:$,previewLocationRoute:V})}),popover:{animate:!0,constrainSize:!0,placement:"bottom",portal:!0}})}),value:V})}),n.jsx(i.Flex,{align:"center",flex:"none",gap:1,padding:1,children:n.jsx(i.MenuButton,{button:n.jsx(i.Button,{fontSize:1,iconRight:u.ChevronDownIcon,mode:"bleed",padding:2,space:2,text:E(ut["connected"===d?b:"previewDrafts"]),loading:"reconnecting"===d&&"loaded"!==a.status,disabled:"connected"!==d}),id:"perspective-menu",menu:n.jsxs(i.Menu,{style:{maxWidth:240},children:[n.jsx(i.MenuItem,{fontSize:1,onClick:()=>r({type:Ge,perspective:"previewDrafts"}),padding:3,pressed:"previewDrafts"===b,tone:dt,children:n.jsxs(i.Flex,{align:"flex-start",gap:3,children:[n.jsx(i.Box,{flex:"none",children:n.jsx(i.Text,{size:1,children:o.createElement(ft.previewDrafts)})}),n.jsxs(i.Stack,{flex:1,space:2,children:[n.jsx(i.Text,{size:1,weight:"medium",children:E(ut.previewDrafts)}),n.jsx(i.Text,{muted:!0,size:1,children:E("preview-frame.perspective.previewDrafts.text")})]}),n.jsx(i.Box,{flex:"none",children:n.jsx(i.Text,{muted:!0,size:1,style:{opacity:"previewDrafts"===b?1:0},children:n.jsx(u.CheckmarkIcon,{})})})]})}),n.jsx(i.MenuItem,{fontSize:1,onClick:()=>r({type:Ge,perspective:"published"}),padding:3,pressed:"published"===b,tone:pt,children:n.jsxs(i.Flex,{align:"flex-start",gap:3,children:[n.jsx(i.Box,{flex:"none",children:n.jsx(i.Text,{size:1,children:o.createElement(ft.published)})}),n.jsxs(i.Stack,{flex:1,space:2,children:[n.jsx(i.Text,{size:1,weight:"medium",children:E(ut.published)}),n.jsx(i.Text,{muted:!0,size:1,children:E("preview-frame.perspective.published.text")})]}),n.jsx(i.Box,{flex:"none",children:n.jsx(i.Text,{muted:!0,size:1,style:{opacity:"published"===b?1:0},children:n.jsx(u.CheckmarkIcon,{})})})]})})]}),popover:{animate:!0,constrainSize:!0,placement:"bottom",portal:!0}})}),n.jsxs(i.Flex,{align:"center",flex:"none",gap:1,padding:1,children:[n.jsx(i.Tooltip,{animate:!0,content:n.jsx(i.Text,{size:1,children:E("preview-frame.viewport-full-button.tooltip")}),fallbackPlacements:["bottom-start"],padding:2,placement:"bottom",portal:!0,children:n.jsx(i.Button,{"aria-label":E("preview-frame.viewport-full-button.aria-label"),fontSize:1,icon:u.DesktopIcon,mode:"bleed",onClick:T,padding:2,selected:"desktop"===k})}),n.jsx(i.Tooltip,{animate:!0,content:n.jsx(i.Text,{size:1,children:E("preview-frame.viewport-narrow-button.tooltip")}),padding:2,placement:"bottom",portal:!0,children:n.jsx(i.Button,{"aria-label":E("preview-frame.viewport-narrow-button.aria-label"),fontSize:1,icon:u.MobileDeviceIcon,mode:"bleed",onClick:R,padding:2,selected:"mobile"===k})})]})]})}),n.jsx(i.Card,{flex:1,tone:"transparent",children:n.jsxs(i.Flex,{align:"center",height:"fill",justify:"center",padding:"desktop"===k?0:2,sizing:"border",style:{position:"relative",cursor:_?"wait":void 0},children:[n.jsx(m.AnimatePresence,{children:O||L||M||!N||W?(L||"connecting"===x&&"refreshing"!==a.status)&&!W?n.jsx(lt,{initial:"initial",animate:"animate",exit:"exit",variants:vt,justify:"center",align:"center",style:{inset:"0",position:"absolute"},children:n.jsxs(i.Flex,{style:{...ht[k]},justify:"center",align:"center",direction:"column",gap:4,children:[n.jsx(i.Spinner,{muted:!0}),n.jsx(i.Text,{muted:!0,size:1,children:E("preview-frame.status",{context:"loading"})})]})}):O&&!W?n.jsx(lt,{initial:"initial",animate:"animate",exit:"exit",variants:gt,justify:"center",align:"center",style:{background:"var(--card-bg-color)",inset:"0",position:"absolute",borderTop:"1px solid transparent",boxShadow:"0 0 0 1px var(--card-border-color)"},children:n.jsx(we,{flex:1,message:E("preview-frame.connection.error.text"),onRetry:F,onContinueAnyway:B,children:C&&n.jsxs(n.Fragment,{children:["connected"!==x&&n.jsx(i.Card,{padding:3,radius:2,tone:"critical",children:n.jsxs(i.Stack,{space:3,children:[n.jsx(i.Label,{muted:!0,size:0,children:E("preview-frame.overlay.connection-status.label")}),n.jsx(i.Code,{size:1,children:E("channel.status",{context:x})})]})}),"connected"!==d&&n.jsx(i.Card,{padding:3,radius:2,tone:"critical",children:n.jsxs(i.Stack,{space:3,children:[n.jsx(i.Label,{muted:!0,size:0,children:E("preview-frame.loader.connection-status.label")}),n.jsx(i.Code,{size:1,children:E("channel.status",{context:d})})]})})]})})}):null:n.jsx(lt,{initial:"initial",animate:"animate",exit:"exit",variants:vt,justify:"center",align:"center",style:{inset:"0",position:"absolute",backdropFilter:z?"blur(16px) saturate(0.5) grayscale(0.5)":"blur(2px)",transition:"backdrop-filter 0.2s ease-in-out",WebkitBackdropFilter:z?"blur(16px) saturate(0.5) grayscale(0.5)":"blur(2px)",WebkitTransition:"-webkit-backdrop-filter 0.2s ease-in-out",zIndex:1},children:n.jsxs(i.Flex,{style:{...ht[k]},justify:"center",align:"center",direction:"column",gap:4,children:[z&&n.jsx(i.Button,{disabled:!0,fontSize:1,mode:"ghost",text:E("preview-frame.continue-button.text"),style:{opacity:0}}),n.jsx(i.Card,{radius:2,tone:z?"caution":"inherit",padding:4,shadow:1,children:n.jsxs(i.Flex,{justify:"center",align:"center",direction:"column",gap:4,children:[n.jsx(i.Spinner,{muted:!0}),n.jsx(i.Text,{muted:!0,size:1,children:E("preview-frame.status",z?{context:"timeout"}:{context:"connecting"})})]})}),z&&n.jsx(i.Button,{fontSize:1,tone:"critical",onClick:B,text:E("preview-frame.continue-button.text")})]})})}),n.jsx(ot,{ref:t,style:{pointerEvents:(L||"connecting"===x&&"refreshing"!==a.status)&&!W?"none":"auto",boxShadow:"0 0 0 1px var(--card-border-color)",borderTop:"1px solid transparent"},src:c.toString(),initial:["background"],variants:xt,animate:[(L||"connecting"===x&&"refreshing"!==a.status)&&!W?"background":"active",L?"reloading":"idle",k,N&&!W?"timedOut":""],onLoad:G})]})})]})})})),ht={desktop:{width:"100%",height:"100%"},mobile:{width:375,height:650}},vt={initial:{opacity:1},animate:{opacity:[0,0,1]},exit:{opacity:[1,0,0]}},gt={initial:{opacity:1},animate:{opacity:[0,0,1]},exit:{opacity:[1,0,0]}},xt={desktop:{...ht.desktop,boxShadow:"0 0 0 0px var(--card-border-color)"},mobile:{...ht.mobile,boxShadow:"0 0 0 1px var(--card-border-color)"},background:{opacity:0,scale:1},idle:{scale:1},reloading:{scale:[1,1,1,.98]},active:{opacity:[0,0,1],scale:1},timedOut:{opacity:[0,0,1]}};let yt=!1;function bt(e,t){return e instanceof Function?e(t):e}function wt(e,t){const n=Array.isArray(e)?e:[e];for(e of n){let n,r=e;if("string"==typeof e)try{const t=new URL(e);n=t.origin,r=t.pathname}catch{}if(!n||t.origin===n)try{const e=g.match(r,{decode:decodeURIComponent})(t.pathname);if(e){const{params:t,path:r}=e;return{origin:n,params:t,path:r}}}catch{throw new Error(`"${e}" is not a valid route pattern`)}}}function jt(e){const{navigate:t,resolvers:n=[],path:r,previewUrl:i}=e,{state:c}=a.useRouter(),u=s.useDocumentStore(),d=s.useClient({apiVersion:l.A}),[p,f]=o.useState(void 0),m=o.useRef(void 0),h=o.useMemo((()=>{var e,t;const n=r||(null==(t=null==(e=c._searchParams)?void 0:e.find((([e])=>"preview"===e)))?void 0:t[1])||"",o="string"==typeof i?i:"object"==typeof i&&(null==i?void 0:i.origin)||location.origin;return new URL(n,o)}),[r,i,c._searchParams]),v=o.useCallback((()=>{f(void 0),m.current=void 0}),[]);return o.useEffect((()=>{if(n.length&&h){let a;for(const e of n){const t=wt(e.route,h);if(t){a={context:t,resolver:e};break}}if(a){const n=function(e,t){var n;if(e.resolve){const r=null==(n=e.resolve(t))?void 0:n.filter;return r?`*[${r}][0]{_id, _type}`:void 0}return"type"in e?`*[_type == "${e.type}"][0]{_id, _type}`:`*[${bt(e.filter,t)}][0]{_id, _type}`}(a.resolver,a.context),c=(e=a.resolver,r=a.context,e.resolve?null!=(o=null==(i=e.resolve(r))?void 0:i.params)?o:r.params:"type"in e?{}:null!=(s=bt(e.params,r))?s:r.params);if(n){const e=new AbortController,r={perspective:"previewDrafts",signal:e.signal};return d.fetch(n,c,r).then((e=>{(!e||m.current!==e._id)&&(f({document:e,path:h.pathname}),null==t||t({id:null==e?void 0:e._id,type:null==e?void 0:e._type}),m.current=null==e?void 0:e._id)})).catch((e=>{e instanceof Error&&"AbortError"===e.name||(f({document:void 0,path:h.pathname}),m.current=void 0)})),()=>{e.abort()}}}}var e,r,i,o,s;v()}),[d,v,u,t,n,h]),p}function Pt(e){var t;if(void 0===e)return;const n=null==(t=decodeURIComponent(e))?void 0:t.split(".");return"drafts"===n[0]&&n.shift(),n.join(".")}function kt(e){if(void 0!==e)return r.studioPath.toString(function(e){const t=[];for(const n of e.split(".")){const e=Q.exec(n);if(e){t.push(e[1],Number(e[2]));continue}const r=Y.exec(n);if(r){t.push(r[1],[Number(r[2]),Number(r[3])]);continue}const i=ee.exec(n);i?t.push(i[1],{_key:i[2]}):t.push(n)}return t}(decodeURIComponent(e)))}function St(e){return Object.fromEntries(Object.entries(e).filter((([,e])=>void 0!==e&&""!==e&&null!==e)))}function Et({initialPreviewUrl:e,routerNavigate:t,routerState:n,routerSearchParams:r,frameStateRef:i}){const a=o.useMemo((()=>{const{id:t,path:i,type:o}={id:Pt((s=n).id),path:kt(s.path),type:s.type};var s;return{id:t,type:o,path:i,preview:r.preview||`${e.pathname}${e.search}`,perspective:r.perspective,viewport:r.viewport,inspect:r.inspect,rev:r.rev,prefersLatestPublished:r.prefersLatestPublished,since:r.since,template:r.template,templateParams:r.templateParams,view:r.view,pathKey:r.pathKey,instruction:r.instruction,comment:r.comment}}),[n,r,e]),c=o.useMemo((()=>St({inspect:a.inspect,path:a.path,rev:a.rev,prefersLatestPublished:a.prefersLatestPublished,since:a.since,template:a.template,templateParams:a.templateParams,view:a.view,pathKey:a.pathKey,instruction:a.instruction,comment:a.comment})),[a.comment,a.inspect,a.instruction,a.path,a.pathKey,a.prefersLatestPublished,a.rev,a.since,a.template,a.templateParams,a.view]),l=o.useRef(n);o.useEffect((()=>{l.current=n}),[n]);return{structureParams:c,navigate:o.useCallback(((e,n={},r)=>{e.id&&(e.id=s.getPublishedId(e.id));const{_searchParams:o,...a}=l.current,c=(o||[]).reduce(((e,[t,n])=>(e[t]=n,e)),{}),u=St({...a,...e}),d=St({...c,...n});a.id!==u.id&&(delete d.template,delete d.templateParams),u._searchParams=Object.entries(d).reduce(((e,[t,n])=>[...e,[t,n]]),[]);const p=null!=r?r:d.preview===i.current.url;t(u,{replace:p})}),[t,i]),params:a}}function Ct(e,t,n){var r,i;const a=s.useClient({apiVersion:l.A}),c=s.useActiveWorkspace(),u=(null==(r=null==c?void 0:c.activeWorkspace)?void 0:r.basePath)||"/",d=(null==(i=null==c?void 0:c.activeWorkspace)?void 0:i.name)||"default",p=function(e,t,n,r){const[i,a]=o.useState((()=>r||"")),c=o.useRef(0);o.useEffect((()=>{if(i&&r)return window.clearTimeout(c.current),()=>{c.current=window.setTimeout((()=>{a("")}),100)}}),[i,r]);const l=s.useCurrentUser();return o.useMemo((()=>["@sanity/presentation",t,n,e,null==l?void 0:l.id,It,i]),[t,null==l?void 0:l.id,e,n,i])}(t,u,d,n),f=function(e,t){const n=s.useClient({apiVersion:l.A}),r=s.useCurrentUser(),[i,a]=o.useState(""),c=e?y.suspend((async()=>await h.createPreviewSecret(n,"@sanity/presentation",typeof window>"u"?"":location.href,null==r?void 0:r.id)),[...t,i]):null;return o.useEffect((()=>{if(!c)return;const e=setTimeout((()=>{o.startTransition((()=>a(c.expiresAt.toString())))}),c.expiresAt.getTime()-Date.now());return()=>clearTimeout(e)}),[c]),(null==c?void 0:c.secret)||null}("object"==typeof e||"function"==typeof e,p);return y.suspend((async()=>{if("string"==typeof e){const t=new URL(e,location.origin);let r=t;try{if(n){const e=new URL(n,t);e.origin===t.origin&&(r=e)}else if(document.referrer){const e=new URL(document.referrer);e.origin===t.origin&&(r=e)}}catch{}return location.origin!==r.origin||!r.pathname.startsWith(`${u}/`)&&r.pathname!==u?r:t}const t=await("object"==typeof e?x.definePreviewUrl(e):e)({client:a,previewUrlSecret:f,previewSearchParam:n,referrer:typeof document>"u"?null:document.referrer,studioBasePath:u});return new URL(t,location.origin)}),[...p,f])}const It=Symbol();const Tt=o.lazy((()=>Promise.resolve().then((function(){return require("./LoaderQueries.cjs")})))),Rt=o.lazy((()=>Promise.resolve().then((function(){return require("./PostMessageRefreshMutations.cjs")})))),Lt=c.styled(i.Flex)`
  overflow-x: auto;
`;exports.default=function(e){var t,c,u,d;const{previewUrl:p,components:f}=null!=(t=e.tool.options)?t:{},m=e.tool.name||l.D,{unstable_navigator:h}=f||{},{navigate:v,state:g}=a.useRouter(),x=s.useUnique(Object.fromEntries(g._searchParams||[])),y=Ct(p||"/",m,x.preview||null),[b]=o.useState((()=>{var t;const n=null==(t=e.tool.options)?void 0:t.devMode;return"function"==typeof n?n():"boolean"==typeof n?n:typeof window<"u"&&"localhost"===window.location.hostname})),j=o.useMemo((()=>y.origin),[y.origin]),P=o.useRef(null),[k,S]=o.useState(),[E,C]=o.useState({}),I=o.useRef({title:void 0,url:void 0}),{navigate:T,params:R,structureParams:L}=Et({initialPreviewUrl:y,routerNavigate:v,routerState:g,routerSearchParams:x,frameStateRef:I}),z=o.useMemo((()=>ie(T,50)),[T]),[D,O]=o.useReducer(Xe,{perspective:R.perspective,viewport:R.viewport},it),[U,_]=function(e,t){if("published"!==e&&"previewDrafts"!==e)throw new Error(`Invalid perspective: ${e}`);const[n,r]=o.useState({}),[i,s]=o.useState({}),a=o.useRef(""),c=o.useCallback(((e,n,i=[])=>{const o=i.filter((e=>"_projectId"in e&&e._projectId?(yt||(console.warn("Cross dataset references are not supported yet, ignoring source document",e),yt=!0),!1):e));("published"===n?r:s)((n=>{const r={};for(const e of o)r[e._id]=e;if(a.current!==t.current.url)return a.current=t.current.url,{[e]:r};const i=n[e];return w.default(i,r)?n:{...n,[e]:r}}))}),[t]);return[o.useMemo((()=>{const t=Object.values("published"===e?n:i).reduce(((e,t)=>(Object.values(t).forEach((t=>{e[t._id]=t})),e)),{});return Object.values(t)}),[e,i,n]),c]}(D.perspective,I),$=s.useProjectId(),A=s.useDataset(),F=jt({resolvers:null==(u=null==(c=e.tool.options)?void 0:c.resolve)?void 0:u.mainDocuments,previewUrl:null==(d=e.tool.options)?void 0:d.previewUrl,path:R.preview,navigate:T});o.useEffect((()=>{(D.perspective!==R.perspective||D.viewport!==R.viewport)&&z({},{perspective:"previewDrafts"===D.perspective?void 0:D.perspective,viewport:"desktop"===D.viewport?void 0:D.viewport})}),[R.perspective,D.perspective,z,D.viewport,R.viewport,R.rev,R.prefersLatestPublished]);const[B,W]=o.useState("connecting"),[q,N]=o.useState("connecting"),[K,V]=o.useState("connecting"),[G]=o.useState((()=>new Set)),J=o.useCallback((e=>{const t=window.open(e,"_blank");t&&G.add(t)}),[G]);o.useEffect((()=>{if(G.size&&k)for(const e of G)e&&"closed"in e&&!e.closed&&k.addSource(e)}),[k,G,G.size]);const H=o.useRef(D.perspective);o.useEffect((()=>{H.current=D.perspective}),[D.perspective]),o.useEffect((()=>{var e;const t=null==(e=P.current)?void 0:e.contentWindow;if(!t)return;const n=function(e){const{destroy:t,send:n}=M(e),r=new Set,i=new WeakMap,o=new Set;return{destroy:()=>{t();for(const e of o)e()},send:(e,...t)=>{n(e,...t);for(const n of r)n&&"closed"in n&&!n.closed&&i.has(n)&&i.get(n)(e,...t)},addSource(t){if(r.has(t))return;if(!("closed"in t))throw console.warn("Source is unsupported",{source:t}),new Error("Source is unsupported");if(t.closed)throw new Error("Source is closed");const{send:n,destroy:s}=M({...e,target:t,connectTo:e.connectTo.map((e=>{const{onStatusUpdate:t,onEvent:n,...r}=e;return{...r,onEvent:n?(...e)=>{const[t]=e;if("preview-kit/documents"!==t&&"overlay/navigate"!==t&&"loader/documents"!==t)return n(...e)}:void 0}}))});o.add(s),i.set(t,n),r.add(t)}}}({id:"presentation",target:t,targetOrigin:j,connectTo:[{id:"overlays",heartbeat:!0,onStatusUpdate:W,onEvent(e,t){if("visual-editing/focus"!==e&&"overlay/focus"!==e||!("id"in t))if("visual-editing/navigate"===e||"overlay/navigate"===e){const{title:e,url:n}=t;I.current.url!==n&&z({},{preview:n}),I.current={title:e,url:n}}else"visual-editing/meta"===e?I.current.title=t.title:"visual-editing/toggle"===e||"overlay/toggle"===e?O({type:He,enabled:t.enabled}):"visual-editing/documents"===e?_("visual-editing",t.perspective,t.documents):"visual-editing/refreshing"===e&&"manual"===t.source?clearTimeout(fe.current):"visual-editing/refreshing"===e&&"mutation"===t.source?O({type:Ke}):"visual-editing/refreshed"===e&&O({type:Ne});else z({type:t.type,id:t.id,path:t.path},{prefersLatestPublished:"isDraft"in t||"previewDrafts"===H.current?void 0:"true"})}},{id:"loaders",heartbeat:!0,onStatusUpdate:N,onEvent(e,t){if("loader/documents"===e&&t.projectId===$&&t.dataset===A)_("loaders",t.perspective,t.documents);else if("loader/query-listen"===e&&t.projectId===$&&t.dataset===A){if("number"==typeof t.heartbeat&&t.heartbeat<l.c)throw new Error(`Loader query listen heartbeat interval must be at least ${l.c}ms`);C((e=>{var n;return{...e,[te(t.query,t.params)]:{perspective:t.perspective,query:t.query,params:t.params,receivedAt:Date.now(),heartbeat:null!=(n=t.heartbeat)&&n}}}))}}},{id:"preview-kit",heartbeat:!0,onStatusUpdate:V,onEvent(e,t){"preview-kit/documents"===e&&t.projectId===$&&t.dataset===A&&_("preview-kit",t.perspective,t.documents)}}]});return S(n),()=>{n.destroy(),S(void 0)}}),[A,$,_,z,j]),o.useEffect((()=>{const e=setInterval((()=>C((e=>{if(Object.keys(e).length<1)return e;const t=Date.now();if(!Object.values(e).some((e=>!1!==e.heartbeat&&t>e.receivedAt+e.heartbeat)))return e;const n={};for(const[r,i]of Object.entries(e))!1!==i.heartbeat&&t>i.receivedAt+i.heartbeat||(n[r]=i);return n}))),l.c);return()=>clearInterval(e)}),[]);const X=o.useCallback((e=>{z({path:r.studioPath.toString(e)},{},!0)}),[z]),Z=o.useCallback((e=>{const t=new URL(e,y.origin),n=t.pathname+t.search;t.origin===y.origin&&n!==R.preview&&z({},{preview:n})}),[y,R,z]),Q=o.useCallback((e=>{z({},e)}),[z]);o.useEffect((()=>{null==k||k.send("overlays","presentation/perspective",{perspective:D.perspective})}),[k,D.perspective]),o.useEffect((()=>{R.id&&R.path?null==k||k.send("overlays","presentation/focus",{id:R.id,path:R.path}):null==k||k.send("overlays","presentation/blur",void 0)}),[k,R.id,R.path]),o.useEffect((()=>{"published"===D.perspective&&R.id&&!R.rev&&!R.prefersLatestPublished&&z({},{prefersLatestPublished:"true"})}),[z,R.id,R.prefersLatestPublished,R.rev,D.perspective]),o.useEffect((()=>{I.current.url&&R.preview&&I.current.url!==R.preview&&(I.current.url=R.preview,"connected"!==B&&P.current?P.current.src=`${j}${R.preview}`:null==k||k.send("overlays","presentation/navigate",{url:R.preview,type:"replace"}))}),[k,B,j,R.preview]);const Y=o.useCallback((()=>null==k?void 0:k.send("overlays","presentation/toggleOverlay",void 0)),[k]),[ee,oe]=o.useState(null);o.useEffect((()=>{const e=e=>{re(e)&&Y()},t=e=>{var t;re(e)&&Y(),t=e,["mod","\\"].every((e=>ne[e]?t[ne[e]]:t.key===e.toUpperCase()))&&Y()};return window.addEventListener("keydown",t),window.addEventListener("keyup",e),()=>{window.removeEventListener("keydown",t),window.removeEventListener("keyup",e)}}),[Y]);const[se,ce]=o.useState(null),[{navigatorEnabled:le,toggleNavigator:ue},de]=Fe({unstable_navigator:h}),pe=o.useRef(R.id);o.useEffect((()=>{R.rev&&pe.current&&R.id!==pe.current&&z({},{rev:void 0}),pe.current=R.id}));const fe=o.useRef(),me=o.useCallback((e=>{if(O({type:Ke}),k)return fe.current=window.setTimeout(e,300),void k.send("overlays","presentation/refresh",{source:"manual",livePreviewEnabled:"connected"===K||"connected"===q});e()}),[k,q,K]),he=s.useWorkspace(),ve=o.useCallback((({id:e,type:t,path:n})=>{if(I.current.url)return{title:I.current.title||I.current.url,name:"edit",params:{id:e,path:n,type:t,inspect:l.C,workspace:he.name,mode:l.E,preview:R.preview}}}),[R.preview,he.name]);return n.jsxs(n.Fragment,{children:[n.jsx(qe,{devMode:b,name:m,navigate:z,params:R,structureParams:L,children:n.jsx(Ae,{navigate:z,children:n.jsx(We,{params:R,children:n.jsx(Lt,{height:"fill",children:n.jsxs(be,{children:[n.jsx(de,{}),n.jsx(ae,{id:"preview",minWidth:325,defaultSize:le?50:75,order:3,children:n.jsx(i.Flex,{direction:"column",flex:1,height:"fill",ref:ce,children:n.jsx(i.BoundaryElementProvider,{element:se,children:n.jsx(mt,{dispatch:O,iframe:D.iframe,initialUrl:y,loadersConnection:q,navigatorEnabled:le,onPathChange:Z,onRefresh:me,openPopup:J,overlaysConnection:B,params:R,perspective:D.perspective,ref:P,targetOrigin:j,toggleNavigator:ue,toggleOverlay:Y,viewport:D.viewport,visualEditing:D.visualEditing})})})}),n.jsx($e,{mainDocumentState:F,params:R,documentsOnPage:U,getCommentIntent:ve,onFocusPath:X,onStructureParams:Q,setDisplayedDocument:oe,structureParams:L})]})})})})}),k&&n.jsx(o.Suspense,{children:n.jsx(Tt,{channel:k,liveQueries:E,perspective:D.perspective,liveDocument:ee,documentsOnPage:U})}),k&&R.id&&R.type&&n.jsx(o.Suspense,{children:n.jsx(Rt,{channel:k,id:R.id,type:R.type,loadersConnection:q,previewKitConnection:K})})]})};//# sourceMappingURL=PresentationTool.cjs.map
