/// <reference types="react" />

import type {ClientPerspective} from '@sanity/client'
import type {ComponentType} from 'react'
import {DocumentStore} from 'sanity'
import type {Observable} from 'rxjs'
import {Plugin as Plugin_2} from 'sanity'
import type {PreviewUrlResolver} from '@sanity/preview-url-secret/define-preview-url'
import type {PreviewUrlResolverOptions} from '@sanity/preview-url-secret/define-preview-url'
import type {QueryParams} from '@sanity/client'
import type {SanityClient} from 'sanity'

/**
 * @internal
 */
export declare type ContextFn<T> = (context: DocumentResolverContext) => T

/**
 * Define documents for a given location.
 * This function doesn't do anything itself, it is used to provide type information.
 * @param resolvers - resolvers that return documents.
 * @public
 */
export declare function defineDocuments(resolvers: DocumentResolver[]): typeof resolvers

/**
 * Define locations for a given document type.
 * This function doesn't do anything itself, it is used to provide type information.
 * @param resolver - resolver that return locations for a document.
 * @public
 */
export declare function defineLocations<K extends string>(
  resolver: DocumentLocationResolverObject<K> | DocumentLocationsState,
): typeof resolver

/**
 * Represents a document location
 * @typeParam title - Title of the document
 * @typeParam href - URL of the document location
 * @public
 */
export declare interface DocumentLocation {
  title: string
  href: string
}

/**
 * Function used for advanced document location resolution
 * @param params - Object with document `id` and document `type` properties
 * @param context - Object with `documentStore` property for creating listenQuery subscriptions
 * @returns Document location state, optionally as an Observable, or null/undefined if no locations are available
 * @public
 */
export declare type DocumentLocationResolver = (
  params: {
    id: string
    type: string
  },
  context: {
    documentStore: DocumentStore
  },
) =>
  | DocumentLocationsState
  | null
  | undefined
  | Observable<DocumentLocationsState | null | undefined>

/**
 * Document location resolver object
 * @typeParam select - object for selecting document fields
 * @typeParam resolve - function that accepts a document with the selected fields and returns an optional document location state
 * @public
 */
export declare type DocumentLocationResolverObject<K extends string = string> = {
  select: Record<K, string>
  resolve: (value: Record<K, any> | null) => DocumentLocationsState | null | undefined | void
}

/**
 * Object of document location resolver definitions per document type
 * @public
 */
export declare type DocumentLocationResolvers = Record<
  string,
  DocumentLocationResolverObject | DocumentLocationsState
>

/**
 * State for describing document locations or providing a message if no document
 * locations are unavailable
 * @typeParam locations - Array of document locations
 * @typeParam message - Message to display if locations are unavailable
 * @typeParam tone - Tone of the message
 * @public
 */
export declare interface DocumentLocationsState {
  locations?: DocumentLocation[]
  message?: string
  tone?: 'positive' | 'caution' | 'critical'
}

/**
 * @internal
 */
export declare type DocumentLocationsStatus = 'empty' | 'resolving' | 'resolved'

/**
 * Object for resolving a document for a given route pattern
 * @public
 */
export declare type DocumentResolver =
  | {
      route: string | Array<string>
      type: string
      filter?: never
      params?: never
      resolve?: never
    }
  | {
      route: string | Array<string>
      type?: never
      filter: ContextFn<string> | string
      params?: ContextFn<Record<string, string>> | Record<string, string>
      resolve?: never
    }
  | {
      route: string | Array<string>
      type?: never
      filter?: never
      params?: never
      resolve: ContextFn<
        | {
            filter: string
            params?: Record<string, string>
          }
        | undefined
      >
    }

/**
 * @internal
 */
export declare interface DocumentResolverContext {
  origin: string | undefined
  params: Record<string, string>
  path: string
}

/** @internal */
export declare interface FrameState {
  title: string | undefined
  url: string | undefined
}

/** @internal */
export declare type LiveQueriesState = Record<string, LiveQueriesStateValue>

/** @internal */
export declare interface LiveQueriesStateValue {
  query: string
  params: QueryParams
  perspective: ClientPerspective
  receivedAt: number
  /**
   * If false it means the query can't safely be garbage collected,
   * as older versions of @sanity/core-loader doesn't fire listen events
   * on an interval.
   */
  heartbeat: number | false
}

/**
 * @internal
 */
export declare interface MainDocument {
  _id: string
  _type: string
}

/**
 * @internal
 */
export declare interface MainDocumentState {
  path: string
  document: MainDocument | undefined
}

export declare interface NavigatorOptions {
  minWidth?: number
  maxWidth?: number
  component: ComponentType
}

export declare type PresentationNavigate = (
  nextState: PresentationStateParams,
  nextSearchState?: PresentationSearchParams,
  forceReplace?: boolean,
) => void

export declare type PresentationNavigateContextValue = (
  preview: string | undefined,
  document?: {
    type: string
    id: string
  },
) => void

export declare interface PresentationParams
  extends PresentationStateParams,
    StructureDocumentPaneParams {
  id?: string
  preview?: string
  perspective?: string
  viewport?: string
}

export declare interface PresentationPluginOptions {
  devMode?: boolean | (() => boolean)
  icon?: ComponentType
  name?: string
  title?: string
  /**
   * @deprecated use `resolve.locations` instead
   */
  locate?: DocumentLocationResolver
  resolve?: {
    mainDocuments?: DocumentResolver[]
    locations?: DocumentLocationResolvers | DocumentLocationResolver
  }
  previewUrl: PreviewUrlOption
  components?: {
    unstable_navigator?: NavigatorOptions
  }
  /**
   * @deprecated this feature flag is no longer needed
   */
  unstable_showUnsafeShareUrl?: boolean
}

export declare interface PresentationSearchParams extends StructureDocumentPaneParams {
  preview?: string
  perspective?: string
  viewport?: string
}

export declare interface PresentationStateParams {
  type?: string
  id?: string
  path?: string
}

export declare const presentationTool: Plugin_2<PresentationPluginOptions>

export declare type PreviewUrlOption =
  | string
  | PreviewUrlResolver<SanityClient>
  | PreviewUrlResolverOptions

export {PreviewUrlResolver}

export {PreviewUrlResolverOptions}

export declare interface StructureDocumentPaneParams {
  inspect?: string
  path?: string
  rev?: string
  prefersLatestPublished?: string
  since?: string
  template?: string
  templateParams?: string
  view?: string
  pathKey?: string
  instruction?: string
  comment?: string
}

export declare function usePresentationNavigate(): PresentationNavigateContextValue

/** @public */
export declare function usePresentationParams(throwOnMissingContext?: true): PresentationParams

/** @public */
export declare function usePresentationParams(
  throwOnMissingContext: false,
): PresentationParams | null

export {}
